<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual HealthCare â€” Polished</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg1:#edf2ff; --panel:rgba(255,255,255,0.72); --muted:#6b7280; --text:#091029; --accent:#2b3bd6; --accent-2:#6b21d8; --accent-3:#ff6b6b; --radius:14px; --glass: rgba(255,255,255,0.6); --pastel-1: #ffd9e8; --pastel-2: #e6f0ff }
    html,body{height:100%}
    body{min-height:100vh;background:linear-gradient(180deg,#eef4ff,#f6fbff);color:var(--text);padding:28px;padding-bottom:220px;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto}

    header.app-header{display:flex;align-items:center;gap:16px;padding:12px;border-radius:12px}
    .brand-title{font-weight:800;font-size:1.25rem;color:var(--accent)}
    .greeting{margin-left:auto;color:var(--muted)}

    /* Hero & panels */
    .hero-panel{margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:16px;background:var(--panel);backdrop-filter:blur(8px);padding:18px;border-radius:16px}
    .hero-content{flex:1;padding:8px 18px;position:relative;z-index:2}
    .hero-title{font-weight:800;font-size:1.3rem;color:var(--accent);line-height:1.1}
    .hero-sub{color:var(--muted);margin-top:6px}
    .hero-image-wrap{width:560px;height:220px;border-radius:12px;overflow:hidden;background:#fff;flex-shrink:0;box-shadow:0 18px 50px rgba(16,24,40,0.06);position:relative;z-index:1}
    .hero-carousel{position:relative;width:100%;height:100%}
    .hero-slide{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .42s ease,transform .4s ease}
    .hero-slide.visible{opacity:1}
    .hero-pager{position:absolute;right:10px;bottom:10px;display:flex;gap:6px;z-index:40}

    /* secondary tabs under hero */
    .secondary-tabs{display:flex;gap:8px;margin-top:12px}
    .tab-btn{background:transparent;border:none;padding:8px 14px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:700;transition:all .18s ease;display:inline-flex;align-items:center}
    .tab-btn i{opacity:.9}
    .tab-btn:hover{transform:translateY(-2px);color:var(--text)}
    .tab-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 20px 40px rgba(43,59,214,0.12);padding:10px 16px}

    /* panels */
    .appt-large{background:var(--panel);backdrop-filter:blur(10px);border-radius:16px;padding:28px;box-shadow:0 18px 40px rgba(16,24,40,0.06);text-align:center;margin-bottom:18px;border:1px solid rgba(255,255,255,0.12)}
    .appt-time{font-weight:800;font-size:44px;margin:12px 0;color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .panel{background:var(--panel);backdrop-filter:blur(8px);padding:18px;border-radius:14px;box-shadow:0 8px 28px rgba(16,24,40,0.04);border:1px solid rgba(255,255,255,0.08)}
    .controls-row{display:flex;gap:12px;margin-top:12px}

    /* improved buttons - pastel + glassmorphism */
    .btn-primary{background:linear-gradient(90deg,var(--pastel-1),var(--pastel-2));color:var(--text);padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.6);cursor:pointer;font-weight:700;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(99,102,241,0.08)}
    .btn-primary:hover{transform:translateY(-2px)}
    .btn-outline{background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.3);padding:10px 16px;border-radius:12px;cursor:pointer;color:var(--text)}
    .btn-outline:hover{transform:translateY(-2px)}

    .doctor-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .doctor-avatar{width:56px;height:56px;border-radius:10px;overflow:hidden}
    .doctor-meta{flex:1}
    .messages-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .message-item{padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(250,251,255,0.95));border:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:center}

    /* quick actions - glassy, pastel */
    .quick-actions{display:flex;gap:12px;margin-top:12px}
    .quick-action{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px;border-radius:14px;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.44));border:1px solid rgba(255,255,255,0.6);cursor:pointer;transition:all .18s ease;backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(43,59,214,0.06)}
    .quick-action i{font-size:18px;color:var(--accent-2)}
    .quick-action div{font-weight:700;color:var(--accent)}
    .quick-action:hover{transform:translateY(-6px)}

    /* bottom nav styling - lifted above content */
    .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:96px;background:linear-gradient(90deg,rgba(255,255,255,0.9),rgba(255,255,255,0.86));padding:10px 20px;border-radius:56px;box-shadow:0 30px 60px rgba(12,20,40,0.14);display:flex;gap:14px;align-items:center;z-index:1400;border:1px solid rgba(255,255,255,0.5);backdrop-filter:blur(8px)}
    .bottom-nav .nav-btn{background:transparent;border:none;padding:8px 14px;border-radius:14px;cursor:pointer;font-weight:700;color:var(--muted);font-size:15px}
    .bottom-nav .nav-btn.primary{background:linear-gradient(90deg,var(--pastel-1),var(--pastel-2));color:var(--text);padding:8px 16px}
    .bottom-nav .nav-btn.active{box-shadow:0 10px 30px rgba(63,81,181,0.06)}

    /* utility classes (replace some inline styles) */
    .ml-12{margin-left:12px}
    .metric-item{flex:1}
    .avatar-circle{width:56px;height:56px;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#eef4ff}
    .timeline-name{margin-top:8px;font-weight:700}

    /* modal & backdrop */
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--panel);padding:18px;border-radius:12px;box-shadow:0 20px 50px rgba(2,6,23,0.2);z-index:120;width:520px}
    .backdrop-fixed{position:fixed;inset:0;background:rgba(2,6,23,0.35);backdrop-filter:blur(2px);z-index:110}

    @media(max-width:980px){ .grid{grid-template-columns:1fr} .hero-image-wrap{display:none} .modal{width:92%} .bottom-nav{bottom:20px} }
  </style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="brand-title">Virtual HealthCare</div>
      <div class="greeting">Welcome, Matilda</div>
      <button id="contrastToggle" class="btn-outline ml-12">High contrast</button>
    </header>

    <!-- Hero banner + secondary tabs -->
    <section class="hero-panel">
      <div class="hero-content">
        <div class="hero-title">Welcome back, <span id="profileGreeting">Matilda</span></div>
        <div class="hero-sub">Your care team and upcoming consults are below.</div>
        <div class="secondary-tabs" role="tablist">
          <button class="tab-btn active" data-section="overview" onclick="showSection('overview')"><i class="fa fa-home" style="margin-right:8px"></i>Overview</button>
          <button class="tab-btn" data-section="messages" onclick="showSection('messages')"><i class="fa fa-envelope" style="margin-right:8px"></i>Messages</button>
          <button class="tab-btn" data-section="prescriptions" onclick="showSection('prescriptions')"><i class="fa fa-prescription-bottle" style="margin-right:8px"></i>Prescriptions</button>
          <button class="tab-btn" data-section="billing" onclick="showSection('billing')"><i class="fa fa-file-invoice-dollar" style="margin-right:8px"></i>Billing</button>
          <button class="tab-btn" data-section="help" onclick="showSection('help')"><i class="fa fa-life-ring" style="margin-right:8px"></i>Help</button>
        </div>
      </div>
      <div class="hero-image-wrap">
        <div id="heroCarousel" class="hero-carousel"></div>
      </div>
    </section>

    <!-- Appointment preview -->
    <section class="appt-large" id="apptPreview">
      <h2>Upcoming Appointments Preview</h2>
      <div class="appt-time" id="apptCountdown">--:--</div>
      <div class="timeline-row" id="timelineRow"></div>
      <div class="appt-actions">
        <button class="btn-outline" id="rescheduleBtn">Reschedule</button>
        <button class="btn-primary" id="joinNowBtn">Join Now</button>
      </div>
    </section>

    <div class="grid">
      <div>
        <div class="panel" id="homePanel">
          <h3 id="overviewTitle">Health Snapshot</h3>
          <p style="color:var(--muted)">Quick glance at recent metrics</p>
          <div id="metrics" style="display:flex;gap:12px;margin-top:12px"></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 240px;gap:12px">
          <div class="panel" id="actionPanel">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
              <button type="button" class="quick-action" id="qa-book" onclick="showBookingModal()" aria-label="Book"><i class="fa fa-calendar-plus"></i><div>Book</div></button>
              <button type="button" class="quick-action" id="qa-consult" onclick="showConsultModal()" aria-label="Consult"><i class="fa fa-video"></i><div>Consult</div></button>
              <button type="button" class="quick-action" id="qa-upload" onclick="document.getElementById('fileInput') && document.getElementById('fileInput').click()" aria-label="Upload"><i class="fa fa-file-medical"></i><div>Upload</div></button>
              <button type="button" class="quick-action" id="qa-sos" onclick="showToast('SOS: emergency services will be contacted')" aria-label="SOS"><i class="fa fa-phone"></i><div>SOS</div></button>
            </div>
          </div>

          <div class="panel" id="doctorsPanel">
            <h3>Care Team</h3>
            <div id="doctorsList" class="doctor-list"></div>
          </div>
        </div>

        <!-- messages -->
        <div class="panel" id="messagesPanel" style="display:none;margin-top:12px">
          <h3>Messages</h3>
          <div style="margin-top:8px;color:var(--muted)">Secure messages with your care team</div>
          <div id="messagesList" class="messages-list"></div>
          <div style="margin-top:12px"><button class="btn-primary" id="composeBtn">Compose</button></div>
        </div>

        <!-- prescriptions -->
        <div class="panel" id="prescriptionsPanel" style="display:none;margin-top:12px">
          <h3>Prescriptions</h3>
          <div id="rxList" class="rx-list"></div>
        </div>

        <!-- records panel -->
        <div class="panel" id="recordsPanel" style="display:none;margin-top:12px">
          <h3>Medical Records</h3>
          <p style="color:var(--muted)">Upload reports or view existing files</p>
          <div style="margin-top:12px;display:flex;gap:8px">
            <input type="file" id="fileInput" style="display:none" />
            <button class="btn-primary" id="uploadFileBtn">Upload File</button>
            <button class="btn-outline" id="newRecordBtn">New Record</button>
          </div>
          <div id="fileList" class="file-list"></div>
        </div>

        <!-- appointments list (hidden by default) -->
        <div class="panel" id="appointmentsPanel" style="display:none;margin-top:12px">
          <h3>Your Appointments</h3>
          <div id="appointmentsList" class="appt-list"></div>
        </div>

      </div>

      <aside>
        <div class="panel">
          <h3>Appointment Details</h3>
          <div id="apptDetails" style="margin-top:8px;color:var(--muted)">No appointment selected</div>
          <div class="controls-row" style="margin-top:12px">
            <button class="btn-primary" id="payBtn">Pay & Confirm</button>
            <button class="btn-outline" id="saveDraft">Save Draft</button>
          </div>
          <div id="billingSummary" style="margin-top:12px;display:none">
            <h4 style="margin:0">Billing</h4>
            <div id="invoicePreview" style="color:var(--muted);margin-top:8px">No invoices</div>
          </div>
        </div>

      </aside>
    </div>

    <footer></footer>
  </div>

  <!-- Bottom navigation -->
  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn" data-view="home" onclick="showView('home')">Home</button>
    <button class="nav-btn" data-view="appointments" onclick="showView('appointments')">Appointments</button>
    <button class="nav-btn primary" data-view="consult" onclick="showView('consult')">Consult</button>
    <button class="nav-btn" data-view="records" onclick="showView('records')">Records</button>
    <button class="nav-btn" data-view="profile" onclick="showView('profile')">Profile</button>
  </div>

  <!-- Payment modal (web stub) -->
  <div id="paymentModal" style="display:none" class="modal" role="dialog" aria-modal="true">
    <h3>Pay for Consultation</h3>
    <div style="color:var(--muted);margin-top:8px">Provider: <span id="pmProvider">-</span></div>
    <div style="margin-top:12px">Amount: <strong id="pmAmount">$25.00</strong></div>
    <div class="row" style="margin-top:12px">
      <input id="cardNumber" placeholder="Card number" class="input-field" />
    </div>
    <div class="row">
      <input id="cardExp" placeholder="MM/YY" class="input-field" />
      <input id="cardCvv" placeholder="CVV" class="input-field" />
    </div>
    <div style="margin-top:12px;display:flex;gap:8px"><button id="confirmPay" class="btn-primary">Confirm Payment</button><button id="cancelPay" class="btn-outline">Cancel</button></div>
  </div>

<script>
// Minimal safe app script (auto-fix)
const STORAGE_KEY = 'vhc_paid_v1';
let state = {};

function uid(){ return Math.random().toString(36).slice(2,9); }
function load(){ try{ const s = localStorage.getItem(STORAGE_KEY); if(s) state = JSON.parse(s); else {
    state = {
      appointments: [{id:'appt1', doctorName:'Dr. Maya Chen', when: new Date(Date.now()+1000*60*60).toISOString(), amount:25}],
      selectedAppt: null,
      files: [],
      profile:{name:'Matilda', medicalDetails:''},
      messages: [{id:'m1',from:'Dr. Maya Chen',subject:'Pre-visit notes',body:'Please complete the questionnaire before the visit.',time:new Date().toISOString(),read:false}],
      prescriptions: [],
      invoices: []
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  const g = document.querySelector('.greeting'); if(g) g.innerText = `Welcome, ${state.profile.name||'Matilda'}`;
  const pg = document.getElementById('profileGreeting'); if(pg) pg.innerText = state.profile.name || 'Matilda';
}catch(e){ console.error('load failed', e); state = state || {}; }
}
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.error('save failed', e); } }
function showToast(msg, t=2000){ const c = document.getElementById('toastRoot') || (()=>{ const el=document.createElement('div'); el.id='toastRoot'; el.className='toast-root'; document.body.appendChild(el); return el; })(); const item = document.createElement('div'); item.className='toast-item'; item.innerText = msg; c.appendChild(item); setTimeout(()=> item.remove(), t); }

// Simple renderers
const HERO_ASSETS = [
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fa6a0ecace4204a3f8ba6076b62c0c063?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fabf33e4dccdb4e26baa183604ef7c510?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2F5b3c6344f3f6425da0bee3a5fff93cdf?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fd5860eca956b4f0c9c2ca8f1ab8838c6?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fe3d58ee5b2e840129aa830c122064ea7?format=webp&width=1200'
];
function renderHeroCarousel(){ const hero = document.getElementById('heroCarousel'); if(!hero) return; hero.innerHTML=''; const fallback = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="420"><rect width="100%" height="100%" fill="%23eef4ff"/><text x="50%" y="50%" alignment-baseline="middle" text-anchor="middle" font-family="Arial" font-size="28" fill="%23919">Virtual HealthCare</text></svg>';
  HERO_ASSETS.forEach((src,i)=>{ const img=document.createElement('img'); img.src = src; img.className='hero-slide'+(i===0?' visible':''); img.style.objectPosition='50% 50%'; img.alt='hero'; img.onerror = ()=>{ img.src = fallback; }; hero.appendChild(img); });
  // simple pager
  const pager = document.createElement('div'); pager.className='hero-pager'; hero.appendChild(pager);
}

const DOCTOR_ASSETS = [
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2F382489ed7db948a7bde3fa337212b435?format=webp&width=400',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2F25ef9274ba4d4fe98a499ac831aad674?format=webp&width=400',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Feaf8d2697eeb40f7960fd0fc1f3c6e60?format=webp&width=400'
];
function renderDoctorsTiles(){ const list=document.getElementById('doctorsList'); if(!list) return; list.innerHTML=''; const docs = [
  {name:'Dr. Maya Chen', spec:'General', img:DOCTOR_ASSETS[0]},
  {name:'Dr. Arjun Patel', spec:'Pediatrics', img:DOCTOR_ASSETS[1]},
  {name:'Dr. Leila Gomez', spec:'Psychiatry', img:DOCTOR_ASSETS[2]}
]; docs.forEach((d, idx)=>{ const row = document.createElement('div'); row.className='doctor-row'; const safeName = String(d.name).replace(/'/g,"\'"); row.innerHTML = `<div class="doctor-avatar"><img src="${d.img}" alt="${safeName}" style="width:100%;height:100%;object-fit:cover" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\'><rect width=\'100%\' height=\'100%\' fill=\'%23eef4ff\'/><text x=\'50%\' y=\'50%\' alignment-baseline=\'middle\' text-anchor=\'middle\' font-family=\'Arial\' font-size=\'18\' fill=\'%239192a6\'>Dr</text></svg>'"/></div><div class="doctor-meta"><div class="doctor-name">${safeName}</div><div class="doctor-special">${d.spec}</div></div><div><button class="btn-outline" data-doc="${safeName}">Book</button></div>`; list.appendChild(row); const btn = row.querySelector('button[data-doc]'); if(btn) btn.addEventListener('click', ()=> showBookingModalWithDoctor(d.name)); }); }

function renderMetrics(){ const node = document.getElementById('metrics'); if(!node) return; node.innerHTML=''; const metrics=[{label:'Sleep',val:'7.5h'},{label:'Stress',val:'Low'},{label:'Meds',val:'On track'}]; metrics.forEach(m=>{ const el=document.createElement('div'); el.className='metric-item'; el.innerHTML = `<div class='metric-value' style='font-weight:700'>${m.val}</div><div class='metric-label' style='color:var(--muted)'>${m.label}</div>`; node.appendChild(el); }); }

function renderMessages(){ const node = document.getElementById('messagesList'); if(!node) return; node.innerHTML=''; (state.messages||[]).forEach(m=>{ const el=document.createElement('div'); el.className='message-item'; el.innerHTML = `<div class='meta'><div style='font-weight:700'>${m.subject}</div><div style='color:var(--muted);font-size:13px'>${m.from} â€¢ ${new Date(m.time).toLocaleString()}</div><div style='color:var(--muted);margin-top:6px;font-size:13px'>${m.body}</div></div><div><button class='btn-outline btn-open' data-id='${m.id}'>Open</button></div>`; node.appendChild(el); }); node.querySelectorAll('.btn-open').forEach(b=> b.addEventListener('click', ()=> openMessage(b.dataset.id))); }
function openMessage(id){ const msg = (state.messages||[]).find(x=> x.id===id); if(!msg) return; const root=document.body; const backdrop = createBackdrop('backdrop_msg'); root.appendChild(backdrop); const modal=document.createElement('div'); modal.className='modal'; modal.innerHTML = `<h3>${msg.subject}</h3><div style='color:var(--muted);margin-top:6px'>From: ${msg.from}</div><div style='margin-top:12px'>${msg.body}</div><div style='margin-top:12px;display:flex;gap:8px'><button id='closeMsg' class='btn-outline'>Close</button></div>`; root.appendChild(modal); document.getElementById('closeMsg').onclick = ()=>{ modal.remove(); backdrop.remove(); }; msg.read = true; saveState(); }

// Appointments
function renderAppointmentPreview(){ const el = document.getElementById('apptCountdown'); const timeline = document.getElementById('timelineRow'); const appt = (state.appointments && state.appointments[0]) || null; if(!el) return; if(!appt){ el.classList.add('appt-time--empty'); el.innerText = 'No upcoming appointments'; timeline.innerHTML=''; document.getElementById('apptDetails').innerText = 'No appointment selected'; return; } el.classList.remove('appt-time--empty'); el.innerText = new Date(appt.when).toLocaleString(); timeline.innerHTML = `<div class="timeline-avatar"><div class="avatar-circle"><img src="" alt="" style="width:100%;height:100%"/></div><div class='timeline-name'>${appt.doctorName}</div></div>`; document.getElementById('apptDetails').innerText = `${appt.doctorName} â€” ${new Date(appt.when).toLocaleString()}`; }
function renderAppointmentsPanel(){ const list = document.getElementById('appointmentsList'); if(!list) return; list.innerHTML=''; (state.appointments||[]).forEach(a=>{ const el=document.createElement('div'); el.className='appt-item'; el.innerHTML = `<div><div style='font-weight:700'>${a.doctorName}</div><div style='color:var(--muted)'>${new Date(a.when).toLocaleString()}</div></div><div style='display:flex;gap:8px'><button class='btn-outline btn-appt-view' data-id='${a.id}'>View</button><button class='btn-outline btn-appt-resched' data-id='${a.id}'>Reschedule</button></div>`; list.appendChild(el); }); list.querySelectorAll('.btn-appt-view').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; const appt = state.appointments.find(x=>x.id===id); if(appt){ state.selectedAppt = appt; renderAppointmentPreview(); showView('appointments'); } })); list.querySelectorAll('.btn-appt-resched').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; const appt = state.appointments.find(x=>x.id===id); if(appt) showRescheduleModal(appt); })); }

function showRescheduleModal(appt){ if(!appt) return; const root=document.body; const backdrop = createBackdrop('backdrop_reschedule'); root.appendChild(backdrop); const modal=document.createElement('div'); modal.className='modal'; modal.innerHTML = `<h3>Reschedule</h3><div style='margin-top:8px'>Doctor: <strong>${appt.doctorName}</strong></div><div style='margin-top:12px'><input id='reschedWhen' type='datetime-local' class='input-field' value='${new Date(appt.when).toISOString().slice(0,16)}' /></div><div style='margin-top:12px;display:flex;gap:8px'><button id='doResched' class='btn-primary'>Save</button><button id='cancelResched' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelResched').onclick = ()=> { modal.remove(); backdrop.remove(); }; document.getElementById('doResched').onclick = ()=>{ const when = document.getElementById('reschedWhen').value; if(!when) { showToast('Pick a valid time'); return; } appt.when = new Date(when).toISOString(); saveState(); renderAppointmentPreview(); renderAppointmentsPanel(); modal.remove(); backdrop.remove(); showToast('Rescheduled'); } }

// Records
function renderRecordsPanel(){ const node = document.getElementById('fileList'); if(!node) return; node.innerHTML=''; const files = state.files || []; if(files.length===0){ node.innerHTML = `<div style='color:var(--muted)'>No medical records. Use Upload or New Record to add.</div>`; return; } files.forEach(f=>{ const el=document.createElement('div'); el.style.marginBottom='8px'; el.innerHTML = `<div style='font-weight:700'>${f.name}</div><div style='color:var(--muted);font-size:12px'>${new Date(f.uploaded).toLocaleString()}</div>`; node.appendChild(el); }); }

function openNewRecordModal(){ if(document.getElementById('newRecordModal')) return; const root=document.body; const backdrop = createBackdrop('backdrop_newrec'); root.appendChild(backdrop); const modal=document.createElement('div'); modal.className='modal'; modal.id='newRecordModal'; modal.innerHTML = `<h3>New Medical Record</h3><div style='margin-top:8px'><label class='label'>Title</label><input id='recTitle' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Notes</label><textarea id='recNotes' class='input-field' style='height:120px'></textarea></div><div style='margin-top:12px;display:flex;gap:8px'><button id='saveRecordBtn' class='btn-primary'>Save</button><button id='cancelRecordBtn' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelRecordBtn').onclick = ()=> { modal.remove(); backdrop.remove(); }; document.getElementById('saveRecordBtn').onclick = ()=>{ const title = document.getElementById('recTitle').value.trim(); const notes = document.getElementById('recNotes').value.trim(); if(!title){ showToast('Please enter a title'); return; } state.files = state.files || []; state.files.unshift({id:uid(), name:title, notes, uploaded:new Date().toISOString()}); saveState(); renderRecordsPanel(); modal.remove(); backdrop.remove(); showToast('Medical record added'); }; }

// simple booking modal
function showBookingModal(){ if(document.getElementById('bookingModal')) return; const root=document.body; const backdrop=createBackdrop('backdrop_booking'); root.appendChild(backdrop); const modal=document.createElement('div'); modal.className='modal'; modal.id='bookingModal'; modal.innerHTML = `<h3>New Booking</h3><div style='margin-top:8px'><label class='label'>Name</label><input id='bkName' value='${state.profile.name||"Matilda"}' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Doctor</label><input id='bkDoc' value='Dr. Maya Chen' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Date & time</label><input id='bkWhen' type='datetime-local' class='input-field' value='${new Date(Date.now()+3600000).toISOString().slice(0,16)}' /></div><div style='margin-top:12px;display:flex;gap:8px'><button id='bkSave' class='btn-primary'>Book</button><button id='bkCancel' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('bkCancel').onclick = ()=> { modal.remove(); backdrop.remove(); }; document.getElementById('bkSave').onclick = ()=>{ const name=document.getElementById('bkName').value.trim(); const doc=document.getElementById('bkDoc').value.trim(); const when=document.getElementById('bkWhen').value; if(!when||!doc){ showToast('Please complete booking fields'); return; } const appt={id:uid(), doctorName:doc, when:new Date(when).toISOString(), amount:25}; state.appointments = state.appointments || []; state.appointments.unshift(appt); saveState(); modal.remove(); backdrop.remove(); renderAppointmentPreview(); renderAppointmentsPanel(); showToast('Booked â€” please pay to confirm'); }; }
function showBookingModalWithDoctor(name){ showBookingModal(); setTimeout(()=>{ const input=document.getElementById('bkDoc'); if(input) input.value = name; },50); }

// simple consult modal
function showConsultModal(){ if(document.getElementById('consultModal')) return; const root=document.body; const backdrop=createBackdrop('backdrop_consult'); root.appendChild(backdrop); const modal=document.createElement('div'); modal.className='modal'; modal.id='consultModal'; modal.innerHTML = `<h3>Start Consult</h3><div style='margin-top:8px;color:var(--muted)'>Video consult â€” simulated</div><div style='margin-top:12px;height:220px;background:#eaf1ff;border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)'>Video preview</div><div style='margin-top:12px;display:flex;gap:8px'><button id='startCall' class='btn-primary'>Start Call</button><button id='cancelCall' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelCall').onclick = ()=>{ modal.remove(); backdrop.remove(); }; document.getElementById('startCall').onclick = ()=>{ showToast('Joining call'); setTimeout(()=>{ modal.remove(); backdrop.remove(); },600); }; }

// simple payment simulation
function simulatePaymentInvoice(inv){ setTimeout(()=>{ inv.paid = true; saveState(); renderBilling(); showToast('Invoice paid'); },900); }
function renderBilling(){ const node=document.getElementById('invoicePreview'); if(!node) return; node.innerHTML=''; (state.invoices||[]).forEach(inv=>{ const el=document.createElement('div'); el.className='invoice-item'; el.innerHTML = `<div><div style='font-weight:700'>${inv.desc}</div><div style='color:var(--muted);font-size:13px'>Amount: $${inv.amount.toFixed(2)}</div></div><div><button class='btn-primary btn-pay' data-id='${inv.id}'>Pay</button></div>`; node.appendChild(el); }); node.querySelectorAll('.btn-pay').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; const inv=(state.invoices||[]).find(x=>x.id===id); if(inv) simulatePaymentInvoice(inv); })); document.getElementById('billingSummary').style.display = (state.invoices && state.invoices.length)?'block':'none'; }

// helpers
function createBackdrop(id){ const existing=document.getElementById(id); if(existing) existing.remove(); const b=document.createElement('div'); b.id=id; b.className='backdrop-fixed'; b.addEventListener('click', ()=>{ const m=document.querySelector('.modal'); if(m) m.remove(); b.remove(); }); return b; }

// navigation
function showSection(section){ try{ const tabs=document.querySelectorAll('.secondary-tabs .tab-btn'); tabs.forEach(b=> b.classList.toggle('active', b.dataset.section===section)); const map={'overview':'homePanel','messages':'messagesPanel','prescriptions':'prescriptionsPanel','billing':'recordsPanel','help':'recordsPanel'}; Object.values(map).forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; }); const panel = map[section] || 'homePanel'; const el=document.getElementById(panel); if(el) el.style.display='block'; if(panel==='homePanel'){ renderAppointmentPreview(); renderMetrics(); renderDoctorsTiles(); } if(panel==='messagesPanel') renderMessages(); if(panel==='prescriptionsPanel' && typeof renderPrescriptions === 'function') renderPrescriptions(); }catch(e){ console.error('showSection error', e); } }
function showView(view){ document.querySelectorAll('.bottom-nav .nav-btn').forEach(b=> b.classList.toggle('active', b.dataset.view===view)); document.getElementById('apptPreview').style.display = (view==='appointments'||view==='home')?'block':'none'; document.getElementById('doctorsPanel').style.display = (view==='home')?'block':'none'; document.getElementById('homePanel').style.display = (view==='home')?'block':'none'; document.getElementById('appointmentsPanel').style.display = (view==='appointments')?'block':'none'; document.getElementById('recordsPanel').style.display = (view==='records')?'block':'none'; if(view==='records') renderRecordsPanel(); if(view==='appointments') renderAppointmentsPanel(); if(view==='profile'){ const apptDetails=document.getElementById('apptDetails'); if(apptDetails) apptDetails.innerHTML = `<div style='font-weight:700'>${state.profile.name||'Matilda'}</div><div style='color:var(--muted);margin-top:6px'>Editable profile â€” change name below</div><div style='margin-top:8px'><input id='profileName' class='input-field' value='${state.profile.name||'Matilda'}' /></div><div style='margin-top:8px'><button id='saveProfile' class='btn-primary'>Save</button></div>`; setTimeout(()=>{ const s=document.getElementById('saveProfile'); if(s) s.onclick = ()=>{ const v=document.getElementById('profileName').value.trim(); if(v) state.profile.name=v; saveState(); const pg=document.getElementById('profileGreeting'); if(pg) pg.innerText = state.profile.name||'Matilda'; showToast('Profile saved'); }; },50); } }

// wire basic interactions
function ensureBindings(){ try{ document.querySelectorAll('.secondary-tabs .tab-btn').forEach(b=> b.addEventListener('click', ()=> showSection(b.dataset.section))); document.querySelectorAll('.bottom-nav .nav-btn').forEach(b=> b.addEventListener('click', ()=> showView(b.dataset.view))); const fileInput=document.getElementById('fileInput'); if(fileInput) fileInput.addEventListener('change', (e)=>{ handleFileInput(e.target.files); }); const uploadBtn=document.getElementById('uploadFileBtn'); if(uploadBtn) uploadBtn.addEventListener('click', ()=>{ const fi=document.getElementById('fileInput'); if(fi) fi.click(); }); const newRec=document.getElementById('newRecordBtn'); if(newRec) newRec.addEventListener('click', ()=> openNewRecordModal()); const qaBook=document.getElementById('qa-book'); if(qaBook) qaBook.addEventListener('click', ()=> showBookingModal()); const qaConsult=document.getElementById('qa-consult'); if(qaConsult) qaConsult.addEventListener('click', ()=> showConsultModal()); const qaUpload=document.getElementById('qa-upload'); if(qaUpload) qaUpload.addEventListener('click', ()=>{ const fi=document.getElementById('fileInput'); if(fi) fi.click(); }); const composeBtn=document.getElementById('composeBtn'); if(composeBtn) composeBtn.addEventListener('click', ()=> composeMessage()); const reschedBtn=document.getElementById('rescheduleBtn'); if(reschedBtn) reschedBtn.addEventListener('click', ()=> { const appt=(state.appointments&&state.appointments[0]); if(appt) showRescheduleModal(appt); else showToast('No appointment'); }); const joinBtn=document.getElementById('joinNowBtn'); if(joinBtn) joinBtn.addEventListener('click', ()=> { const appt=(state.appointments&&state.appointments[0]); if(appt) showView('appointments'); else showBookingModal(); }); }catch(e){ console.error('ensureBindings failed', e); } }

// init
load(); renderHeroCarousel(); renderMetrics(); renderDoctorsTiles(); renderAppointmentPreview(); renderAppointmentsPanel(); renderRecordsPanel(); renderBilling(); renderMessages(); renderPrescriptions && renderPrescriptions();

// lightweight missing functions to avoid errors
function renderPrescriptions(){ const node = document.getElementById('rxList'); if(!node) return; node.innerHTML=''; const rx = state.prescriptions || []; if(rx.length===0){ node.innerHTML = `<div style="color:var(--muted)">No prescriptions</div>`; return; } rx.forEach(r=>{ const el=document.createElement('div'); el.style.marginBottom='8px'; el.innerHTML = `<div style="font-weight:700">${r.name||r.med||'Prescription'}</div><div style="color:var(--muted);font-size:13px">${r.instructions||''}</div>`; node.appendChild(el); }); }

function handleFileInput(files){ if(!files || files.length===0) return; state.files = state.files || []; Array.from(files).forEach(f=> state.files.unshift({id:uid(), name:f.name, uploaded:new Date().toISOString()})); saveState(); renderRecordsPanel(); showToast('Files uploaded'); }

function composeMessage(){ if(document.getElementById('composeModal')) return; const root=document.body; const b=createBackdrop('backdrop_compose'); root.appendChild(b); const m=document.createElement('div'); m.className='modal'; m.id='composeModal'; m.innerHTML = `<h3>Compose Message</h3><div style='margin-top:8px'><input id='msgTo' class='input-field' placeholder='To' /></div><div style='margin-top:8px'><input id='msgSubject' class='input-field' placeholder='Subject' /></div><div style='margin-top:8px'><textarea id='msgBody' class='input-field' style='height:140px'></textarea></div><div style='margin-top:12px;display:flex;gap:8px'><button id='sendMsg' class='btn-primary'>Send</button><button id='cancelMsg' class='btn-outline'>Cancel</button></div>`; root.appendChild(m); document.getElementById('cancelMsg').onclick = ()=>{ m.remove(); b.remove(); }; document.getElementById('sendMsg').onclick = ()=>{ const to=document.getElementById('msgTo').value.trim(); const subject=document.getElementById('msgSubject').value.trim(); const body=document.getElementById('msgBody').value.trim(); if(!subject || !body) { showToast('Please add subject and message'); return; } state.messages = state.messages || []; state.messages.unshift({id:uid(), from:state.profile.name||'You', subject, body, time:new Date().toISOString(), read:false}); saveState(); renderMessages(); m.remove(); b.remove(); showToast('Message sent'); }; }

//
// cleanup any stray modal/backdrop from previous broken state that can block UI
try{ document.querySelectorAll('.backdrop-fixed').forEach(el=> el.remove()); document.querySelectorAll('.modal').forEach(el=>{ if(el.id && el.id==='paymentModal'){ el.style.display='none'; } else { el.remove(); } }); }catch(e){ console.warn('cleanup failed', e); }
// expose core functions as globals for inline onclicks
try{ window.showSection = showSection; window.showView = showView; window.showBookingModal = showBookingModal; window.showConsultModal = showConsultModal; window.showToast = showToast; window.openNewRecordModal = openNewRecordModal; window.showBookingModalWithDoctor = showBookingModalWithDoctor; window.composeMessage = composeMessage; window.handleFileInput = handleFileInput; window.renderPrescriptions = renderPrescriptions; }catch(e){}
ensureBindings(); try{ showView('home'); showSection('overview'); }catch(e){ console.error('init failed', e); }
</script>
</body>
</html>
