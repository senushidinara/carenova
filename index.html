<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual HealthCare â€” Polished</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg1:#edf2ff; --panel:rgba(255,255,255,0.96); --muted:#6b7280; --text:#091029; --accent:#2b3bd6; --accent-2:#6b21d8; --accent-3:#ff6b6b; --radius:14px }
    body{min-height:100vh;background:linear-gradient(180deg,#eef4ff,#f6fbff);color:var(--text);padding:28px;padding-bottom:220px;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto}

    header.app-header{display:flex;align-items:center;gap:16px;padding:12px;border-radius:12px}
    .brand-title{font-weight:800;font-size:1.25rem;color:var(--accent)}
    .greeting{margin-left:auto;color:var(--muted)}

    /* Hero & panels */
    .hero-panel{margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:16px;background:var(--panel);backdrop-filter:blur(6px);padding:12px;border-radius:12px}
    .hero-content{flex:1;padding:18px}
    .hero-title{font-weight:800;font-size:1.2rem;color:var(--accent)}
    .hero-sub{color:var(--muted);margin-top:6px}
    .hero-image-wrap{width:640px;height:240px;border-radius:12px;overflow:hidden;background:#fff;flex-shrink:0;box-shadow:0 10px 30px rgba(16,24,40,0.06);position:relative}
    .hero-image-wrap .hero-carousel{width:100%;height:100%;position:relative}
    .hero-carousel{position:relative;width:100%;height:100%}.hero-slide{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .42s ease,transform .4s ease}.hero-slide.visible{opacity:1;transform:translateZ(0)}
    .hero-pager{position:absolute;right:10px;bottom:10px;display:flex;gap:6px}
    .hero-image-wrap::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,0.0),rgba(10,10,30,0.03));pointer-events:none;border-radius:12px}
    .hero-dot{width:10px;height:10px;border-radius:50%;border:none;cursor:pointer;background:rgba(255,255,255,0.6)}
    .hero-dot.active{background:var(--accent)}
    .hero-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.28);color:white;border:none;width:34px;height:34px;border-radius:8px;cursor:pointer}
    .hero-arrow.left{left:8px}
    .hero-arrow.right{right:8px}

    /* secondary tabs under hero */
    .secondary-tabs{display:flex;gap:8px;margin-top:12px}
    .tab-btn{background:transparent;border:none;padding:8px 14px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:700;transition:all .18s ease;display:inline-flex;align-items:center}
    .tab-btn i{opacity:.9}
    .tab-btn:hover{transform:translateY(-2px);color:var(--text)}
    .tab-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 20px 40px rgba(43,59,214,0.16);padding:10px 16px;transform:translateY(-2px)}

    /* Upcoming appointment preview styled like references (glass) */
    .appt-large{background:var(--panel);backdrop-filter:blur(8px);border-radius:16px;padding:36px;box-shadow:0 18px 40px rgba(16,24,40,0.08);text-align:center;margin-bottom:18px;border:1px solid rgba(15,23,42,0.04);transition:transform .18s ease}
    .appt-large:hover{transform:translateY(-4px)}
    .appt-large h2{margin:0;font-size:1.1rem;color:#1f2937}
    .appt-time{font-weight:900;font-size:56px;margin:12px 0;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;color:transparent}
    .appt-time--empty{background:none;-webkit-background-clip:initial;color:var(--muted);font-size:20px;font-weight:600;margin:8px 0}
    .timeline-row{display:flex;align-items:center;gap:22px;justify-content:center;margin-top:18px}
    .timeline-avatar{display:flex;flex-direction:column;align-items:center;font-size:13px;color:var(--muted)}
    .avatar-circle{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:800;overflow:hidden}
    .appt-actions{display:flex;gap:12px;justify-content:center;margin-top:20px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .panel{background:var(--panel);backdrop-filter:blur(6px);padding:18px;border-radius:14px;box-shadow:0 8px 28px rgba(16,24,40,0.04);border:1px solid rgba(15,23,42,0.03);transition:box-shadow .18s ease,transform .14s ease} .panel:hover{transform:translateY(-6px);box-shadow:0 24px 60px rgba(16,24,40,0.12)}
    .panel:hover{box-shadow:0 14px 40px rgba(16,24,40,0.06)}

    .controls-row{display:flex;gap:12px;margin-top:12px}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:12px 20px;border-radius:12px;border:none;cursor:pointer;font-weight:700;transition:transform .12s ease}
    .btn-primary:active{transform:translateY(1px)}
    .btn-primary{box-shadow:0 6px 18px rgba(43,59,214,0.12)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 14px 40px rgba(43,59,214,0.18)}
    @keyframes floatUp{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    .hero-panel .hero-content{animation:floatUp 6s ease-in-out infinite}
    .btn-outline{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:10px 18px;border-radius:12px;cursor:pointer}

    .quick-actions{display:flex;gap:12px;margin-top:12px}
    .quick-action{display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.92),rgba(255,255,255,0.88));border:1px solid rgba(15,23,42,0.04);cursor:pointer;transition:transform .12s ease,box-shadow .12s ease} .quick-action:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(43,59,214,0.06)} .quick-action i{font-size:18px;color:var(--accent)}
    .quick-action i{font-size:18px;color:var(--accent)}

    .doctor-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .doctor-row{display:flex;align-items:center;gap:10px}
    .doctor-avatar{width:56px;height:56px;border-radius:10px;overflow:hidden}
    .doctor-meta{flex:1}
    .doctor-name{font-weight:700}
    .doctor-special{color:var(--muted);font-size:12px}

    /* messages */
    .messages-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .message-item{padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(245,247,255,0.9));border:1px solid rgba(15,23,42,0.04);display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 20px rgba(12,20,40,0.04)} .message-item .meta{max-width:76%}

    /* prescriptions */
    .rx-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .rx-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(245,247,255,0.9));border:1px solid rgba(15,23,42,0.04);box-shadow:0 8px 20px rgba(12,20,40,0.04)}

    /* billing */
    .invoice-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .invoice-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(245,247,255,0.9));border:1px solid rgba(15,23,42,0.04);box-shadow:0 8px 20px rgba(12,20,40,0.04)}

    /* modal & backdrop */
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--panel);padding:18px;border-radius:12px;box-shadow:0 20px 50px rgba(2,6,23,0.2);z-index:120;width:480px}
    .modal .row{display:flex;gap:8px;margin-top:12px}
    .backdrop-fixed{position:fixed;inset:0;background:rgba(2,6,23,0.35);backdrop-filter:blur(2px);z-index:110}
    .input-field{width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8}
    .label{display:block;margin-bottom:6px}

    /* bottom nav */
    .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:36px;background:linear-gradient(90deg,rgba(255,255,255,0.95),rgba(255,255,255,0.9));padding:10px 18px;border-radius:48px;box-shadow:0 18px 40px rgba(12,20,40,0.12);display:flex;gap:12px;align-items:center;z-index:1200;backdrop-filter:blur(6px)}
    .nav-btn{background:transparent;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:var(--muted)}
    .nav-btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    .nav-btn.active{box-shadow:0 6px 18px rgba(63,81,181,0.12)}

    .toast-root{position:fixed;right:20px;bottom:20px;z-index:9999}
    .toast-item{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:10px 14px;border-radius:10px;margin-top:8px;box-shadow:0 8px 20px rgba(12,20,40,0.2)}

    /* high contrast mode */
    .high-contrast{--panel:#fff;--muted:#374151;--text:#031026;--accent:#0b61ff;--accent-2:#ff6b6b}
    .high-contrast body{background:#f6f9ff}
    .high-contrast .panel{border-color:rgba(3,6,12,0.06)}

    @media(max-width:980px){ .grid{grid-template-columns:1fr} .hero-image-wrap{display:none} }
  </style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="brand-title">Virtual HealthCare</div>
      <div class="greeting">Welcome, Matilda</div>
      <button id="contrastToggle" class="btn-outline" style="margin-left:12px">High contrast</button>
    </header>

    <!-- Hero banner + secondary tabs -->
    <section class="hero-panel">
      <div class="hero-content">
        <div class="hero-title">Welcome back, <span id="profileGreeting">Matilda</span></div>
        <div class="hero-sub">Your care team and upcoming consults are below.</div>
        <div class="secondary-tabs" role="tablist">
          <button class="tab-btn active" data-section="overview"><i class="fa fa-home" style="margin-right:8px"></i>Overview</button>
          <button class="tab-btn" data-section="messages"><i class="fa fa-envelope" style="margin-right:8px"></i>Messages</button>
          <button class="tab-btn" data-section="prescriptions"><i class="fa fa-prescription-bottle" style="margin-right:8px"></i>Prescriptions</button>
          <button class="tab-btn" data-section="billing"><i class="fa fa-file-invoice-dollar" style="margin-right:8px"></i>Billing</button>
          <button class="tab-btn" data-section="help"><i class="fa fa-life-ring" style="margin-right:8px"></i>Help</button>
        </div>
      </div>
      <div class="hero-image-wrap">
        <div id="heroCarousel" class="hero-carousel"></div>
      </div>
    </section>

    <!-- Appointment preview -->
    <section class="appt-large" id="apptPreview">
      <h2>Upcoming Appointments Preview</h2>
      <div class="appt-time" id="apptCountdown">--:--</div>
      <div class="timeline-row" id="timelineRow"></div>
      <div class="appt-actions">
        <button class="btn-outline" id="rescheduleBtn">Reschedule</button>
        <button class="btn-primary" id="joinNowBtn">Join Now</button>
      </div>
    </section>

    <div class="grid">
      <div>
        <div class="panel" id="homePanel">
          <h3 id="overviewTitle">Health Snapshot</h3>
          <p style="color:var(--muted)">Quick glance at recent metrics</p>
          <div id="metrics" style="display:flex;gap:12px;margin-top:12px"></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 240px;gap:12px">
          <div class="panel" id="actionPanel">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
              <div class="quick-action" id="qa-book"><i class="fa fa-calendar-plus"></i><div>Book</div></div>
              <div class="quick-action" id="qa-consult"><i class="fa fa-video"></i><div>Consult</div></div>
              <div class="quick-action" id="qa-upload"><i class="fa fa-file-medical"></i><div>Upload</div></div>
              <div class="quick-action" id="qa-sos"><i class="fa fa-phone"></i><div>SOS</div></div>
            </div>
          </div>

          <div class="panel" id="doctorsPanel">
            <h3>Care Team</h3>
            <div id="doctorsList" class="doctor-list"></div>
          </div>
        </div>

        <!-- messages -->
        <div class="panel" id="messagesPanel" style="display:none;margin-top:12px">
          <h3>Messages</h3>
          <div style="margin-top:8px;color:var(--muted)">Secure messages with your care team</div>
          <div id="messagesList" class="messages-list"></div>
          <div style="margin-top:12px"><button class="btn-primary" id="composeBtn">Compose</button></div>
        </div>

        <!-- prescriptions -->
        <div class="panel" id="prescriptionsPanel" style="display:none;margin-top:12px">
          <h3>Prescriptions</h3>
          <div id="rxList" class="rx-list"></div>
        </div>

        <!-- records panel -->
        <div class="panel" id="recordsPanel" style="display:none;margin-top:12px">
          <h3>Medical Records</h3>
          <p style="color:var(--muted)">Upload reports or view existing files</p>
          <div style="margin-top:12px;display:flex;gap:8px">
            <input type="file" id="fileInput" style="display:none" />
            <button class="btn-primary" id="uploadFileBtn">Upload File</button>
            <button class="btn-outline" id="newRecordBtn">New Record</button>
          </div>
          <div id="fileList" class="file-list"></div>
        </div>

        <!-- appointments list (hidden by default) -->
        <div class="panel" id="appointmentsPanel" style="display:none;margin-top:12px">
          <h3>Your Appointments</h3>
          <div id="appointmentsList" class="appt-list"></div>
        </div>

      </div>

      <aside>
        <div class="panel">
          <h3>Appointment Details</h3>
          <div id="apptDetails" style="margin-top:8px;color:var(--muted)">No appointment selected</div>
          <div class="controls-row" style="margin-top:12px">
            <button class="btn-primary" id="payBtn">Pay & Confirm</button>
            <button class="btn-outline" id="saveDraft">Save Draft</button>
          </div>
          <div id="billingSummary" style="margin-top:12px;display:none">
            <h4 style="margin:0">Billing</h4>
            <div id="invoicePreview" style="color:var(--muted);margin-top:8px">No invoices</div>
          </div>
        </div>

      </aside>
    </div>

    <footer></footer>
  </div>

  <!-- Bottom navigation -->
  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn" data-view="home">Home</button>
    <button class="nav-btn" data-view="appointments">Appointments</button>
    <button class="nav-btn primary" data-view="consult">Consult</button>
    <button class="nav-btn" data-view="records">Records</button>
    <button class="nav-btn" data-view="profile">Profile</button>
  </div>

  <!-- Payment modal (web stub) -->
  <div id="paymentModal" style="display:none" class="modal" role="dialog" aria-modal="true">
    <h3>Pay for Consultation</h3>
    <div style="color:var(--muted);margin-top:8px">Provider: <span id="pmProvider">-</span></div>
    <div style="margin-top:12px">Amount: <strong id="pmAmount">$25.00</strong></div>
    <div class="row" style="margin-top:12px">
      <input id="cardNumber" placeholder="Card number" class="input-field" />
    </div>
    <div class="row">
      <input id="cardExp" placeholder="MM/YY" class="input-field" />
      <input id="cardCvv" placeholder="CVV" class="input-field" />
    </div>
    <div style="margin-top:12px;display:flex;gap:8px"><button id="confirmPay" class="btn-primary">Confirm Payment</button><button id="cancelPay" class="btn-outline">Cancel</button></div>
  </div>

<script>
// App state (local-only demo; saved to localStorage)
  const STORAGE_KEY = 'vhc_paid_v1';
  let state = {
  appointments: [{id:'appt1', doctorName:'Dr. Maya Chen', when: new Date(Date.now()+1000*60*60).toISOString(), amount:25}],
  selectedAppt: null,
  files: [],
  profile:{name:'Matilda', medicalDetails:''},
  messages: [
    {id:'m1',from:'Dr. Maya Chen',subject:'Pre-visit notes',body:'Please complete the questionnaire before the visit.',time:new Date().toISOString(),read:false},
    {id:'m2',from:'Reception',subject:'Clinic hours',body:'We are open Mon-Fri 8am-6pm.',time:new Date().toISOString(),read:true}
  ],
  prescriptions: [
    {id:'r1',name:'Atorvastatin 10mg',sig:'1 tab daily',refills:1},
    {id:'r2',name:'Vitamin D 1000IU',sig:'1 tab daily',refills:3}
  ],
  invoices: [
    {id:'i1',desc:'Consultation â€” Dr. Maya Chen',amount:25.00,paid:false}
  ]
};

const HERO_ASSETS = [
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fa6a0ecace4204a3f8ba6076b62c0c063?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fabf33e4dccdb4e26baa183604ef7c510?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2F5b3c6344f3f6425da0bee3a5fff93cdf?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fd5860eca956b4f0c9c2ca8f1ab8838c6?format=webp&width=1200',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Fe3d58ee5b2e840129aa830c122064ea7?format=webp&width=1200'
];
const HERO_POSITIONS = ['30% 50%','48% 50%','50% 40%','40% 50%','60% 40%'];
const DOCTOR_ASSETS = [
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2F382489ed7db948a7bde3fa337212b435?format=webp&width=400',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2F25ef9274ba4d4fe98a499ac831aad674?format=webp&width=400',
  'https://cdn.builder.io/api/v1/image/assets%2Fcc8773f43a5c46e1986e144b83b3dcd4%2Feaf8d2697eeb40f7960fd0fc1f3c6e60?format=webp&width=400'
];

function uid(){ return Math.random().toString(36).slice(2,9); }
function load(){ const s = localStorage.getItem(STORAGE_KEY); if(s) state = JSON.parse(s); if(!state.appointments || !state.appointments.length){ state.appointments = [{id:'appt1', doctorName:'Dr. Maya Chen', when: new Date(Date.now()+1000*60*60).toISOString(), amount:25}]; } if(!state.profile) state.profile = {name:'Matilda', medicalDetails: ''}; if(!('medicalDetails' in state.profile)) state.profile.medicalDetails = state.profile.medicalDetails || ''; document.querySelector('.greeting').innerText = `Welcome, ${state.profile.name || 'Matilda'}`; document.getElementById('profileGreeting').innerText = state.profile.name || 'Matilda'; }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function showToast(msg, timeout=2600){ let container = document.getElementById('toastRoot'); if(!container){ container = document.createElement('div'); container.id='toastRoot'; container.className='toast-root'; document.body.appendChild(container); } const t = document.createElement('div'); t.className='toast-item'; t.innerText = msg; container.appendChild(t); setTimeout(()=> t.remove(), timeout); }

// contrast toggle
function setContrast(enabled){ if(enabled) document.documentElement.classList.add('high-contrast'); else document.documentElement.classList.remove('high-contrast'); localStorage.setItem('vhc_contrast', enabled? '1':'0'); }
function initContrast(){ const v = localStorage.getItem('vhc_contrast'); if(v==='1'){ setContrast(true); } document.getElementById('contrastToggle').addEventListener('click', ()=>{ const active = document.documentElement.classList.toggle('high-contrast'); localStorage.setItem('vhc_contrast', active? '1':'0'); showToast(active? 'High contrast on':'High contrast off'); }); }
function ensureModalRoot(){ const existing = document.getElementById('modalRoot'); if(existing) existing.remove(); return document.body; }
function createBackdrop(id){ const b = document.createElement('div'); b.id = id; b.className = 'backdrop-fixed'; b.tabIndex = -1; b.addEventListener('click', ()=> { const m = document.querySelector('.modal'); if(m) { m.remove(); b.remove(); } }); return b; }

// Messages
function renderMessages(){ const node = document.getElementById('messagesList'); node.innerHTML=''; (state.messages||[]).forEach(m=>{ const el = document.createElement('div'); el.className='message-item'; el.innerHTML = `<div class='meta'><div style='font-weight:700'>${m.subject}</div><div style='color:var(--muted);font-size:13px'>${m.from} â€¢ ${new Date(m.time).toLocaleString()}</div><div style='color:var(--muted);margin-top:6px;font-size:13px'>${m.body.length>120? m.body.slice(0,120)+'...':m.body}</div></div><div><button class='btn-outline' data-id='${m.id}'>Open</button></div>`; node.appendChild(el); }); node.querySelectorAll('button[data-id]').forEach(b=> b.addEventListener('click', ()=> openMessage(b.dataset.id))); }
function openMessage(id){ const msg = state.messages.find(m=>m.id===id); if(!msg) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_msg'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='msgModal'; modal.innerHTML = `<h3>${msg.subject}</h3><div style='color:var(--muted);margin-top:6px'>From: ${msg.from}</div><div style='margin-top:12px'>${msg.body}</div><div style='margin-top:12px;display:flex;gap:8px'><button id='replyBtn' class='btn-primary'>Reply</button><button id='closeMsg' class='btn-outline'>Close</button></div>`; root.appendChild(modal); document.getElementById('closeMsg').onclick = ()=> { modal.remove(); backdrop.remove(); }; document.getElementById('replyBtn').onclick = ()=> { modal.remove(); backdrop.remove(); composeMessage(msg.from); }; msg.read = true; saveState(); }
function composeMessage(to='Care Team'){ if(document.getElementById('composeModal')) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_compose'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='composeModal'; modal.innerHTML = `<h3>New Message</h3><div style='margin-top:8px'><label class='label'>To</label><input id='msgTo' class='input-field' value='${to}' /></div><div style='margin-top:8px'><label class='label'>Subject</label><input id='msgSub' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Message</label><textarea id='msgBody' class='input-field' style='height:120px'></textarea></div><div style='margin-top:12px;display:flex;gap:8px'><button id='sendMsg' class='btn-primary'>Send</button><button id='cancelMsg' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelMsg').onclick = ()=> { modal.remove(); backdrop.remove(); }; document.getElementById('sendMsg').onclick = ()=> { const toD=document.getElementById('msgTo').value.trim(); const sub=document.getElementById('msgSub').value.trim(); const body=document.getElementById('msgBody').value.trim(); if(!sub||!body){ showToast('Please add subject and message'); return; } state.messages.unshift({id:uid(),from:toD,subject:sub,body, time:new Date().toISOString(),read:false}); saveState(); modal.remove(); backdrop.remove(); renderMessages(); showToast('Message sent'); }; }

// Prescriptions
function renderPrescriptions(){ const node = document.getElementById('rxList'); if(!node) return; node.innerHTML=''; const toolbar = document.createElement('div'); toolbar.style.display='flex'; toolbar.style.justifyContent='space-between'; toolbar.style.alignItems='center'; toolbar.style.marginBottom='8px'; toolbar.innerHTML = `<div style='color:var(--muted)'>Active prescriptions</div><div><button id='addPrescriptionBtn' class='btn-primary'>Add Prescription</button></div>`; node.appendChild(toolbar); const list = document.createElement('div'); list.className='rx-list-inner'; (state.prescriptions||[]).forEach(r=>{ const el=document.createElement('div'); el.className='rx-item'; const hist = (r.history && r.history.length)? `<div style='color:var(--muted);font-size:12px;margin-top:6px'>History: ${r.history.map(h=> new Date(h.when).toLocaleString() + ' ('+h.action+')').join(' | ')}</div>` : ''; el.innerHTML = `<div><div style='font-weight:700'>${r.name}</div><div style='color:var(--muted);font-size:13px'>${r.sig} â€¢ Refills left: ${r.refills}</div>${hist}</div><div style='display:flex;flex-direction:column;gap:6px'><button class='btn-primary btn-rx-refill' data-id='${r.id}'>Refill</button><button class='btn-outline btn-rx-view' data-id='${r.id}'>View</button></div>`; list.appendChild(el); }); node.appendChild(list); node.querySelectorAll('.btn-rx-refill').forEach(b=> b.addEventListener('click', ()=> refillPrescription(b.dataset.id))); node.querySelectorAll('.btn-rx-view').forEach(b=> b.addEventListener('click', ()=> viewPrescription(b.dataset.id))); const addBtn = document.getElementById('addPrescriptionBtn'); if(addBtn) addBtn.onclick = ()=> openAddPrescriptionModal(); }

// small metrics rendering
function renderMetrics(){ const node = document.getElementById('metrics'); if(!node) return; node.innerHTML=''; const metrics=[{label:'Sleep',val:'7.5h'},{label:'Stress',val:'Low'},{label:'Meds',val:'On track'}]; metrics.forEach(m=>{ const el=document.createElement('div'); el.style.flex='1'; el.innerHTML = `<div style='font-weight:700'>${m.val}</div><div style='color:var(--muted)'>${m.label}</div>`; node.appendChild(el); }); }

// quick buttons wiring
function renderQuickButtons(){ try{ document.getElementById('qa-book') && (document.getElementById('qa-book').onclick = ()=> openBookingFlow()); document.getElementById('qa-consult') && (document.getElementById('qa-consult').onclick = ()=> showConsultModal()); document.getElementById('qa-upload') && (document.getElementById('qa-upload').onclick = ()=> document.getElementById('fileInput') && document.getElementById('fileInput').click()); document.getElementById('qa-sos') && (document.getElementById('qa-sos').onclick = ()=> showToast('SOS: emergency services will be contacted')); document.getElementById('uploadFileBtn') && (document.getElementById('uploadFileBtn').onclick = ()=> document.getElementById('fileInput') && document.getElementById('fileInput').click()); // compose handled elsewhere
  }catch(e){ console.error('renderQuickButtons error', e); } }

// wrapper used by quick actions
function openBookingFlow(){ try{ showBookingModal(); }catch(err){ console.error('openBookingFlow error', err); showToast('Unable to open booking modal'); } }
function refillPrescription(id){ const rx = state.prescriptions.find(r=>r.id===id); if(!rx) return; rx.history = rx.history || []; if(rx.refills>0){ rx.refills--; rx.history.push({when:new Date().toISOString(), action:'refill_requested'}); saveState(); renderPrescriptions(); showToast('Refill requested â€” available at pharmacy'); } else { rx.history.push({when:new Date().toISOString(), action:'refill_failed_no_refills'}); saveState(); renderPrescriptions(); showToast('No refills left â€” request new prescription'); } }

function openAddPrescriptionModal(){ if(document.getElementById('addRxModal')) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_addrx'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='addRxModal'; modal.innerHTML = `<h3>New Prescription</h3><div style='margin-top:8px'><label class='label'>Medication name</label><input id='rxName' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Sig</label><input id='rxSig' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Refills</label><input id='rxRefills' type='number' class='input-field' value='1' /></div><div style='margin-top:12px;display:flex;gap:8px'><button id='saveRx' class='btn-primary'>Add</button><button id='cancelRx' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelRx').onclick = ()=>{ modal.remove(); backdrop.remove(); }; document.getElementById('saveRx').onclick = ()=>{ const name = document.getElementById('rxName').value.trim(); const sig = document.getElementById('rxSig').value.trim(); const refills = parseInt(document.getElementById('rxRefills').value,10) || 0; if(!name||!sig){ showToast('Please fill medication and sig'); return; } const rx = { id: uid(), name, sig, refills, history: [{when:new Date().toISOString(), action:'created'}] }; state.prescriptions = state.prescriptions || []; state.prescriptions.unshift(rx); saveState(); renderPrescriptions(); modal.remove(); backdrop.remove(); showToast('Prescription added'); }; }

function viewPrescription(id){ const rx = (state.prescriptions||[]).find(r=> r.id===id); if(!rx) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_viewrx'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='viewRxModal'; const historyHtml = (rx.history||[]).map(h=> `<div style="color:var(--muted);font-size:12px">${new Date(h.when).toLocaleString()} â€” ${h.action}</div>`).join(''); modal.innerHTML = `<h3>${rx.name}</h3><div style='color:var(--muted);margin-top:6px'>${rx.sig} â€¢ Refills: ${rx.refills}</div><div style='margin-top:12px'>${historyHtml || '<div style="color:var(--muted)">No history</div>'}</div><div style='margin-top:12px;display:flex;gap:8px'><button id='closeRxView' class='btn-outline'>Close</button></div>`; root.appendChild(modal); document.getElementById('closeRxView').onclick = ()=>{ modal.remove(); backdrop.remove(); }; }

// Billing
function renderBilling(){ const node = document.getElementById('invoicePreview'); node.innerHTML='No invoices'; const list = document.createElement('div'); list.className='invoice-list'; (state.invoices||[]).forEach(inv=>{ const el=document.createElement('div'); el.className='invoice-item'; el.innerHTML = `<div><div style='font-weight:700'>${inv.desc}</div><div style='color:var(--muted);font-size:13px'>Amount: $${inv.amount.toFixed(2)}</div></div><div><button class='btn-primary' data-id='${inv.id}'>Pay</button></div>`; list.appendChild(el); }); node.innerHTML=''; node.appendChild(list); node.querySelectorAll('button[data-id]').forEach(b=> b.addEventListener('click', ()=> { const inv = state.invoices.find(i=>i.id===b.dataset.id); if(inv) openPaymentForInvoice(inv); })); document.getElementById('billingSummary').style.display = (state.invoices&&state.invoices.length)?'block':'none'; }
function openPaymentForInvoice(inv){ const modal = document.getElementById('paymentModal'); const prov = document.getElementById('pmProvider'); const amt = document.getElementById('pmAmount'); if(!modal || !prov || !amt){ showToast('Payment UI not available'); return; } prov.innerText = inv.desc; amt.innerText = `$${inv.amount.toFixed(2)}`; modal.style.display = 'block'; const backdrop = createBackdrop('backdrop_payment'); document.body.appendChild(backdrop); const cancel = document.getElementById('cancelPay'); const confirm = document.getElementById('confirmPay'); if(cancel) cancel.onclick = ()=>{ modal.style.display='none'; backdrop.remove(); }; if(confirm) confirm.onclick = ()=> { simulatePaymentInvoice(inv); }; }

// Payment for appointment (used by Join Now)
function openPaymentIfRequired(appt){ try{ if(!appt) { showToast('No appointment'); return; } // show same payment modal
  const modal = document.getElementById('paymentModal'); const prov = document.getElementById('pmProvider'); const amt = document.getElementById('pmAmount'); if(!modal || !prov || !amt){ showToast('Payment UI not available'); return; } prov.innerText = appt.doctorName; amt.innerText = `$${(appt.amount||25).toFixed(2)}`; modal.style.display = 'block'; const backdrop = createBackdrop('backdrop_payment'); document.body.appendChild(backdrop); const cancel = document.getElementById('cancelPay'); const confirm = document.getElementById('confirmPay'); if(cancel) cancel.onclick = ()=>{ modal.style.display='none'; backdrop.remove(); }; if(confirm) confirm.onclick = ()=> { // simple validation
      const numEl = document.getElementById('cardNumber'); if(numEl && numEl.value.trim().length<12){ showToast('Enter a valid card number'); return; } // simulate
      document.getElementById('confirmPay').innerText = 'Processing...'; setTimeout(()=>{ document.getElementById('confirmPay').innerText = 'Confirm Payment'; modal.style.display='none'; const bp=document.getElementById('backdrop_payment'); if(bp) bp.remove(); appt.paid = true; saveState(); showToast('Payment successful â€” joining call'); // placeholder for navigation
      },1200); }; }catch(e){ console.error('openPaymentIfRequired error', e); showToast('Payment failed'); } }

// Reschedule modal
function showRescheduleModal(appt){ try{ if(!appt) { showToast('No appointment to reschedule'); return; } if(document.getElementById('rescheduleModal')) return; const root=ensureModalRoot(); const backdrop=createBackdrop('backdrop_reschedule'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='rescheduleModal'; modal.innerHTML = `<h3>Reschedule Appointment</h3><div style='margin-top:8px'>Doctor: <strong>${appt.doctorName}</strong></div><div style='margin-top:12px'><input id='reschedWhen' type='datetime-local' class='input-field' value='${new Date(appt.when).toISOString().slice(0,16)}' /></div><div style='margin-top:12px;display:flex;gap:8px'><button id='doResched' class='btn-primary'>Save</button><button id='cancelResched' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); const cancel = document.getElementById('cancelResched'); if(cancel) cancel.addEventListener('click', ()=>{ modal.remove(); backdrop.remove(); }); const doReschedBtn = document.getElementById('doResched'); if(doReschedBtn) doReschedBtn.addEventListener('click', ()=>{ const when = document.getElementById('reschedWhen').value; if(!when){ showToast('Pick a valid time'); return; } appt.when = new Date(when).toISOString(); saveState(); renderAppointmentPreview(); modal.remove(); backdrop.remove(); showToast('Rescheduled'); }); }catch(e){ console.error('showRescheduleModal error', e); showToast('Unable to reschedule'); } }
function simulatePaymentInvoice(inv){ const num = document.getElementById('cardNumber').value.trim(); if(num.length<12){ showToast('Enter a valid card number'); return; } document.getElementById('confirmPay').innerText = 'Processing...'; setTimeout(()=>{ document.getElementById('confirmPay').innerText = 'Confirm Payment'; document.getElementById('paymentModal').style.display='none'; const bp=document.getElementById('backdrop_payment'); if(bp) bp.remove(); inv.paid=true; saveState(); renderBilling(); showToast('Invoice paid'); },1200); }

// render doctors
function renderDoctorsTiles(){ try{ const list = document.getElementById('doctorsList'); if(!list) return; list.innerHTML=''; const docs = [ {name:'Dr. Maya Chen',img:DOCTOR_ASSETS[0],spec:'General'}, {name:'Dr. Arjun Patel',img:DOCTOR_ASSETS[1],spec:'Pediatrics'}, {name:'Dr. Leila Gomez',img:DOCTOR_ASSETS[2],spec:'Psychiatry'} ]; docs.forEach(d=>{ try{ const row=document.createElement('div'); row.className='doctor-row'; const safeName = String(d.name).replace(/'/g,"\'"); const safeSpec = String(d.spec).replace(/'/g,"\'"); row.innerHTML = `<div class='doctor-avatar'><img src='${d.img}' alt='${safeName}' style='width:100%;height:100%;object-fit:cover' /></div><div class='doctor-meta'><div class='doctor-name'>${safeName}</div><div class='doctor-special'>${safeSpec}</div></div><div><button class='btn-outline' data-doc='${safeName}'>Book</button></div>`; list.appendChild(row); }catch(e){ console.error('doctor row render error', e); } }); list.querySelectorAll('button[data-doc]').forEach(b=> b.addEventListener('click', ()=> showBookingModalWithDoctor(b.dataset.doc))); }catch(err){ console.error('renderDoctorsTiles error', err); } }

// Booking modal (created on demand)
function showBookingModal(){ if(document.getElementById('bookingModal')) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_booking'); root.appendChild(backdrop);
  const modal = document.createElement('div'); modal.className='modal'; modal.id='bookingModal'; modal.innerHTML = `<h3>New Booking</h3><div style='margin-top:8px'><label class='label'>Name</label><input id='bkName' value='${state.profile.name || 'Matilda'}' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Doctor</label><input id='bkDoc' value='Dr. Maya Chen' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Date & time</label><input id='bkWhen' type='datetime-local' class='input-field' value='${new Date(Date.now()+3600000).toISOString().slice(0,16)}' /></div><div style='margin-top:12px;display:flex;gap:8px'><button id='bkSave' class='btn-primary'>Book</button><button id='bkCancel' class='btn-outline'>Cancel</button></div>`;
  root.appendChild(modal);
  const cancelBtn = document.getElementById('bkCancel'); if(cancelBtn) cancelBtn.addEventListener('click', ()=>{ modal.remove(); backdrop.remove(); });
  const saveBtn = document.getElementById('bkSave'); if(saveBtn) saveBtn.addEventListener('click', ()=>{ const name=document.getElementById('bkName') && document.getElementById('bkName').value.trim(); const doc=document.getElementById('bkDoc') && document.getElementById('bkDoc').value.trim(); const when=document.getElementById('bkWhen') && document.getElementById('bkWhen').value; if(!when || !doc){ showToast('Please complete booking fields'); return; } const appt={id:uid(),doctorName:doc,when:new Date(when).toISOString(),amount:25}; state.appointments.unshift(appt); saveState(); modal.remove(); backdrop.remove(); renderAppointmentPreview(); renderAppointmentsPanel(); showToast('Booked â€” please pay to confirm'); });
}
// helper to prefill doctor
function showBookingModalWithDoctor(name){ try{ showBookingModal(); setTimeout(()=>{ const input = document.getElementById('bkDoc'); if(input) input.value = name; },50); }catch(err){ console.error('showBookingModalWithDoctor error', err); } }

// appointments preview
function renderAppointmentPreview(){ const countdownEl = document.getElementById('apptCountdown'); const timelineRow = document.getElementById('timelineRow'); const appt = (state.appointments && state.appointments.length) ? state.appointments[0] : null; const joinBtn = document.getElementById('joinNowBtn'); const reschedBtn = document.getElementById('rescheduleBtn'); if(!appt){ countdownEl.classList.add('appt-time--empty'); countdownEl.innerText = 'No upcoming appointments'; timelineRow.innerHTML=''; if(reschedBtn) reschedBtn.style.display='none'; if(joinBtn){ joinBtn.innerText='Book'; joinBtn.onclick = ()=> openBookingFlow(); } document.getElementById('apptDetails').innerText = 'No appointment selected'; return; } countdownEl.classList.remove('appt-time--empty'); const detailsEl = document.getElementById('apptDetails'); if(detailsEl) detailsEl.innerText = `${appt.doctorName} â€” ${new Date(appt.when).toLocaleString()}`; function updateCountdown(){ const diff = new Date(appt.when) - new Date(); if(diff<=0){ countdownEl.innerText='Due'; } else { const mins = Math.floor(diff/60000); const hrs = Math.floor(mins/60); const m = String(mins%60).padStart(2,'0'); countdownEl.innerText = `${hrs}:${m}`; } } updateCountdown(); if(window.__apptTimer) clearInterval(window.__apptTimer); window.__apptTimer = setInterval(updateCountdown,10000); timelineRow.innerHTML=''; const imgSrc = DOCTOR_ASSETS[0]; const node = document.createElement('div'); node.className = 'timeline-avatar'; node.innerHTML = `\n    <div class=\"avatar-circle\">\n      <img src=\"${imgSrc}\" alt=\"${appt.doctorName}\" style=\"width:100%;height:100%;object-fit:cover\" />\n    </div>\n    <div style='margin-top:8px;font-weight:700'>${appt.doctorName}</div>\n  `; timelineRow.appendChild(node); if(reschedBtn){ reschedBtn.style.display='inline-block'; reschedBtn.onclick = ()=> { if(typeof showRescheduleModal==='function') showRescheduleModal(appt); else { console.error('showRescheduleModal missing'); showToast('Reschedule not available'); } }; } if(joinBtn){ joinBtn.innerText='Join Now'; joinBtn.onclick = ()=> { state.selectedAppt = appt; if(typeof openPaymentIfRequired==='function') openPaymentIfRequired(appt); else if(typeof openPaymentForInvoice==='function') openPaymentForInvoice(appt); else { console.error('payment function missing'); showToast('Payment not available'); } }; } }

// appointments list
function renderAppointmentsPanel(){ const list = document.getElementById('appointmentsList'); if(!list) return; list.innerHTML=''; const appts = state.appointments || []; if(appts.length===0){ list.innerHTML = `<div style='color:var(--muted)'>No appointments scheduled</div>`; return; } appts.forEach(a=>{ const el=document.createElement('div'); el.className='appt-item'; el.innerHTML = `<div><div style='font-weight:700'>${a.doctorName}</div><div style='color:var(--muted)'>${new Date(a.when).toLocaleString()}</div></div><div style='display:flex;gap:8px'><button class='btn-outline btn-appt-view' data-id='${a.id}'>View</button><button class='btn-outline btn-appt-resched' data-id='${a.id}'>Reschedule</button><button class='btn-outline btn-appt-cancel' data-id='${a.id}'>Cancel</button><button class='btn-primary btn-appt-pay' data-id='${a.id}'>Pay</button></div>`; list.appendChild(el); }); // wire actions
  list.querySelectorAll('.btn-appt-view').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; const appt = state.appointments.find(x=>x.id===id); if(appt){ state.selectedAppt=appt; renderAppointmentPreview(); showView('appointments'); } }));
  list.querySelectorAll('.btn-appt-resched').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; const appt = state.appointments.find(x=>x.id===id); if(appt) showRescheduleModal(appt); }));
  list.querySelectorAll('.btn-appt-cancel').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; if(!confirm('Cancel appointment?')) return; cancelAppointment(id); }));
  list.querySelectorAll('.btn-appt-pay').forEach(b=> b.addEventListener('click', ()=> { const id=b.dataset.id; const appt = state.appointments.find(x=>x.id===id); if(appt) openPaymentIfRequired(appt); })); }

function cancelAppointment(id){ const idx = (state.appointments||[]).findIndex(a=>a.id===id); if(idx>-1){ state.appointments.splice(idx,1); if(state.selectedAppt && state.selectedAppt.id===id) state.selectedAppt=null; saveState(); renderAppointmentsPanel(); renderAppointmentPreview(); showToast('Appointment canceled'); } }

// records
function handleFileInput(files){ if(!files || files.length===0) return; for(const f of files){ const id = uid(); state.files.push({id,name:f.name,size:f.size,type:f.type,uploaded: new Date().toISOString()}); } saveState(); renderRecordsPanel(); showToast('File(s) uploaded'); }
function renderRecordsPanel(){ const node = document.getElementById('fileList'); if(!node) return; node.innerHTML=''; const files = state.files || []; if(files.length===0){ node.innerHTML = `<div style='color:var(--muted)'>No medical records. Use Upload or New Record to add.</div>`; return; } files.forEach(f=>{ const el = document.createElement('div'); el.className = 'file-item'; const tagsHtml = (f.tags && f.tags.length)? `<div style='margin-top:6px;color:var(--muted);font-size:12px'>Tags: ${f.tags.join(', ')}</div>` : ''; const dateStr = f.uploaded ? new Date(f.uploaded).toLocaleString() : ''; const title = f.title || f.name || 'Record'; const snippet = f.notes? (f.notes.length>120? f.notes.slice(0,120)+'...': f.notes) : ''; el.innerHTML = `<div><div style='font-weight:700'>${title}</div><div style='color:var(--muted);font-size:12px'>${dateStr}</div><div style='color:var(--muted);margin-top:6px;font-size:13px'>${snippet}</div>${tagsHtml}</div><div style='display:flex;flex-direction:column;gap:6px'><button class='btn-outline btn-record-view' data-id='${f.id}'>View</button><button class='btn-outline btn-record-delete' data-id='${f.id}'>Delete</button></div>`; node.appendChild(el); }); // wire view/delete
  node.querySelectorAll('.btn-record-view').forEach(b=> b.addEventListener('click', ()=> viewRecord(b.dataset.id)));
  node.querySelectorAll('.btn-record-delete').forEach(b=> b.addEventListener('click', ()=> { if(confirm('Delete record?')){ deleteRecord(b.dataset.id); } })); }

function viewRecord(id){ const rec = (state.files||[]).find(r=> r.id===id); if(!rec) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_viewrec'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='viewRecordModal'; modal.innerHTML = `<h3>${rec.title||'Record'}</h3><div style='color:var(--muted);margin-top:6px'>Uploaded: ${rec.uploaded? new Date(rec.uploaded).toLocaleString() : 'â€”'}</div><div style='margin-top:12px'>${rec.notes ? `<div style='margin-bottom:8px'>${rec.notes.replace(/\n/g,'<br/>')}</div>` : '<div style="color:var(--muted)">No notes</div>'}</div><div style='margin-top:8px;color:var(--muted)'>${rec.tags && rec.tags.length? 'Tags: '+rec.tags.join(', '):''}</div><div style='margin-top:12px;display:flex;gap:8px'><button id='closeViewRec' class='btn-outline'>Close</button><button id='downloadRec' class='btn-primary'>Download</button></div>`; root.appendChild(modal); document.getElementById('closeViewRec').onclick = ()=>{ modal.remove(); backdrop.remove(); }; document.getElementById('downloadRec').onclick = ()=>{ showToast('Download would start (stub)'); }; }

function deleteRecord(id){ state.files = (state.files||[]).filter(f=> f.id !== id); saveState(); renderRecordsPanel(); showToast('Record deleted'); }

function openNewRecordModal(){ if(document.getElementById('newRecordModal')) return; const root = ensureModalRoot(); const backdrop = createBackdrop('backdrop_newrec'); root.appendChild(backdrop); const modal = document.createElement('div'); modal.className='modal'; modal.id='newRecordModal'; modal.innerHTML = `<h3>New Medical Record</h3><div style='margin-top:8px'><label class='label'>Title</label><input id='recTitle' class='input-field' /></div><div style='margin-top:8px'><label class='label'>Notes</label><textarea id='recNotes' class='input-field' style='height:120px'></textarea></div><div style='margin-top:8px'><label class='label'>Tags (comma separated)</label><input id='recTags' class='input-field' /></div><div style='margin-top:12px;display:flex;gap:8px'><button id='saveRecordBtn' class='btn-primary'>Save</button><button id='cancelRecordBtn' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelRecordBtn').onclick = ()=>{ modal.remove(); backdrop.remove(); }; document.getElementById('saveRecordBtn').onclick = ()=>{ const title = document.getElementById('recTitle').value.trim(); const notes = document.getElementById('recNotes').value.trim(); const tags = document.getElementById('recTags').value.split(',').map(t=>t.trim()).filter(Boolean); if(!title){ showToast('Please enter a title'); return; } const rec = { id: uid(), title, notes, tags, uploaded: new Date().toISOString() }; state.files = state.files || []; state.files.unshift(rec); saveState(); renderRecordsPanel(); modal.remove(); backdrop.remove(); showToast('Medical record added'); }; }

// consult modal
function showConsultModal(){ if(document.getElementById('consultModal')) return; const root=ensureModalRoot(); const backdrop=createBackdrop('backdrop_consult'); root.appendChild(backdrop); const modal=document.createElement('div'); modal.className='modal'; modal.id='consultModal'; modal.innerHTML = `<h3>Start Consult</h3><div style='margin-top:8px;color:var(--muted)'>Simulated video session</div><div style='margin-top:12px;height:220px;background:#eaf1ff;border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)'>Video preview</div><div style='margin-top:12px;display:flex;gap:8px'><button id='startCall' class='btn-primary'>Start Call</button><button id='cancelCall' class='btn-outline'>Cancel</button></div>`; root.appendChild(modal); document.getElementById('cancelCall').onclick = ()=> { modal.remove(); backdrop.remove(); }; document.getElementById('startCall').onclick = ()=> { showToast('Joining call'); setTimeout(()=>{ modal.remove(); backdrop.remove(); },600); }; }

// hero carousel
function renderHeroCarousel(){ const hero=document.getElementById('heroCarousel'); if(!hero) return; hero.innerHTML=''; HERO_ASSETS.forEach((src,i)=>{ const img=document.createElement('img'); img.src=src; img.dataset.index = i; img.className='hero-slide' + (i===0? ' visible':''); img.style.objectPosition = HERO_POSITIONS[i] || '50% 50%'; hero.appendChild(img); }); // arrows
  const left=document.createElement('button'); left.className='hero-arrow left'; left.innerHTML='\u2039'; left.addEventListener('click', ()=> changeHero(-1)); const right=document.createElement('button'); right.className='hero-arrow right'; right.innerHTML='\u203a'; right.addEventListener('click', ()=> changeHero(1)); hero.appendChild(left); hero.appendChild(right); // pager
  const pager=document.createElement('div'); pager.className='hero-pager'; HERO_ASSETS.forEach((_,i)=>{ const dot=document.createElement('button'); dot.className='hero-dot' + (i===0? ' active':'' ); dot.addEventListener('click', ()=> setHero(i)); pager.appendChild(dot); }); hero.appendChild(pager); }
function getCurrentHeroIndex(){ const hero=document.getElementById('heroCarousel'); const imgs = hero.querySelectorAll('.hero-slide'); let idx=0; imgs.forEach((im,i)=>{ if(window.getComputedStyle(im).opacity !== '0') idx=i; }); return idx; }
function setHero(i){ const hero=document.getElementById('heroCarousel'); if(!hero) return; const imgs = hero.querySelectorAll('.hero-slide'); imgs.forEach((im,idx)=>{ im.classList.toggle('visible', idx===i); }); const dots = hero.querySelectorAll('.hero-dot'); dots.forEach((d,idx)=> d.classList.toggle('active', idx===i)); }
function changeHero(delta){ const idx = getCurrentHeroIndex(); const next = (idx + delta + HERO_ASSETS.length) % HERO_ASSETS.length; setHero(next); }

// show section (secondary tabs)
function showSection(section){ console.log('showSection called with', section); // set active tab
  document.querySelectorAll('.secondary-tabs .tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.section===section));
  // hide panels
  const panels = ['messagesPanel','prescriptionsPanel','recordsPanel','appointmentsPanel','homePanel']; panels.forEach(p=> document.getElementById(p) && (document.getElementById(p).style.display='none'));
  // per-section theme (accent colors and hero)
  const THEMES = {
    overview: {accent:'var(--accent)',accent2:'var(--accent-2)',hero:0},
    messages: {accent:'#0bb5a6',accent2:'#06a58a',hero:1},
    prescriptions: {accent:'#0b8f3b',accent2:'#2fc26b',hero:2},
    billing: {accent:'#ff7a3d',accent2:'#ff4d6d',hero:3},
    help: {accent:'#6c6f76',accent2:'#bdbfc4',hero:4}
  };
  const cfgTheme = THEMES[section] || THEMES.overview;
  try{ document.documentElement.style.setProperty('--accent', cfgTheme.accent); document.documentElement.style.setProperty('--accent-2', cfgTheme.accent2);}catch(e){}

  // update hero title/subtitle and hero image per section for distinct feel
  const titleEl = document.querySelector('.hero-title'); const subEl = document.querySelector('.hero-sub');
  const mapping = { overview: {title:`Welcome back, <span id="profileGreeting">${state.profile.name||'Matilda'}</span>`, sub:'Your care team and upcoming consults are below.', hero:0 },
                    messages: {title:'Messages', sub:'Secure messages with your care team â€” open or compose a new message.', hero:1 },
                    prescriptions: {title:'Prescriptions', sub:'View and request refills for your active medications.', hero:2 },
                    billing: {title:'Billing', sub:'View invoices and pay securely.', hero:3 },
                    help: {title:'Help & Support', sub:'Find guides or contact our support team.', hero:4 } };
  const cfg = mapping[section] || mapping.overview; if(titleEl) titleEl.innerHTML = cfg.title; if(subEl) subEl.innerText = cfg.sub; setHero(cfg.hero);
  // ensure overview renders required panels and data
  if(section==='overview'){ try{ renderAppointmentPreview(); renderMetrics(); renderDoctorsTiles(); }catch(e){ console.error('render overview parts failed', e); } }
  const actionPanelEl = document.getElementById('actionPanel'); if(actionPanelEl) actionPanelEl.style.display = (section==='overview' || section==='messages' || section==='prescriptions' || section==='records') ? 'block' : 'none';
  // customize action panel per section
  if(actionPanelEl){ if(section==='overview'){ actionPanelEl.innerHTML = `<h3>Quick Actions</h3><div class='quick-actions'><div class='quick-action' id='qa-book'><i class='fa fa-calendar-plus'></i><div>Book</div></div><div class='quick-action' id='qa-consult'><i class='fa fa-video'></i><div>Consult</div></div><div class='quick-action' id='qa-upload'><i class='fa fa-file-medical'></i><div>Upload</div></div><div class='quick-action' id='qa-sos'><i class='fa fa-phone'></i><div>SOS</div></div></div>`; renderQuickButtons(); }
    else if(section==='messages'){ actionPanelEl.innerHTML = `<h3>Messages Actions</h3><div style='margin-top:8px;display:flex;gap:8px'><button id='composeQuick' class='btn-primary'>Compose</button><button id='markAllRead' class='btn-outline'>Mark all read</button></div>`; setTimeout(()=>{ const c=document.getElementById('composeQuick'); if(c) c.onclick = ()=> composeMessage(); const m=document.getElementById('markAllRead'); if(m) m.onclick = ()=> { (state.messages||[]).forEach(x=> x.read=true); saveState(); renderMessages(); showToast('All messages marked read'); }; },40); }
    else if(section==='prescriptions'){ actionPanelEl.innerHTML = `<h3>Prescriptions</h3><div style='margin-top:8px;display:flex;gap:8px'><button id='addRxQuick' class='btn-primary'>Add Prescription</button><button id='reqRefillAll' class='btn-outline'>Request refill for all</button></div>`; setTimeout(()=>{ const a=document.getElementById('addRxQuick'); if(a) a.onclick = ()=> openAddPrescriptionModal(); const r=document.getElementById('reqRefillAll'); if(r) r.onclick = ()=> { (state.prescriptions||[]).forEach(p=> refillPrescription(p.id)); saveState(); renderPrescriptions(); showToast('Refill requests sent'); }; },40); }
    else if(section==='records'){ actionPanelEl.innerHTML = `<h3>Records</h3><div style='margin-top:8px;display:flex;gap:8px'><button id='uploadQuick' class='btn-primary'>Upload File</button><button id='newRecQuick' class='btn-outline'>New Record</button></div>`; setTimeout(()=>{ const up=document.getElementById('uploadQuick'); if(up) up.onclick = ()=> fileInputEl && fileInputEl.click(); const n=document.getElementById('newRecQuick'); if(n) n.onclick = ()=> openNewRecordModal(); },40); }
    else { actionPanelEl.innerHTML = ''; } }

  if(section==='overview'){ document.getElementById('homePanel').style.display='block'; }
  if(section==='messages'){ document.getElementById('messagesPanel').style.display='block'; renderMessages(); }
  if(section==='prescriptions'){ document.getElementById('prescriptionsPanel').style.display='block'; renderPrescriptions(); }
  if(section==='billing'){ document.getElementById('recordsPanel').style.display='block'; renderBilling(); }
  if(section==='help'){ const panel = document.getElementById('recordsPanel'); panel.style.display='block'; panel.querySelector('h3').innerText='Help & Support'; panel.querySelector('p').innerText='Contact support or view guides.'; }
}

// view switcher for bottom nav
function showView(view){ const mapping = { home:0, appointments:1, consult:2, records:0, profile:1 }; setHero(mapping[view]||0); document.getElementById('apptPreview').style.display = (view==='appointments' || view==='home') ? 'block' : 'none'; document.getElementById('doctorsPanel').style.display = (view==='home') ? 'block' : 'none'; document.getElementById('homePanel').style.display = (view==='home') ? 'block' : 'none'; document.getElementById('appointmentsPanel').style.display = (view==='appointments') ? 'block' : 'none'; document.getElementById('recordsPanel').style.display = (view==='records') ? 'block' : 'none'; if(view==='records') renderRecordsPanel(); if(view==='appointments') renderAppointmentsPanel(); if(view==='profile'){ const apptDetails = document.getElementById('apptDetails'); apptDetails.innerHTML = `<div style='font-weight:700'>${state.profile.name || 'Matilda'}</div><div style='color:var(--muted);margin-top:6px'>Editable profile â€” change name below</div><div style='margin-top:8px'><input id='profileName' class='input-field' value='${state.profile.name || 'Matilda'}' /></div><div style='margin-top:8px'><button id='saveProfile' class='btn-primary'>Save</button></div>`; setTimeout(()=>{ document.getElementById('saveProfile').onclick = ()=>{ const v=document.getElementById('profileName').value.trim(); if(v){ state.profile.name = v; saveState(); document.querySelector('.greeting').innerText = `Welcome, ${v}`; document.getElementById('profileGreeting').innerText = v; showToast('Profile updated'); } } },50); } document.querySelectorAll('.bottom-nav .nav-btn').forEach(b=> b.classList.toggle('active', b.dataset.view===view)); }

// init
load(); renderHeroCarousel(); renderMetrics(); renderQuickButtons(); renderDoctorsTiles(); renderAppointmentPreview(); renderAppointmentsPanel(); renderRecordsPanel(); renderBilling(); renderMessages(); renderPrescriptions(); initContrast && initContrast();

// wire bottom nav
document.querySelectorAll('.bottom-nav .nav-btn').forEach(b=> b.addEventListener('click', ()=> showView(b.dataset.view)));
// wire secondary tabs
const secTabBtns = document.querySelectorAll('.secondary-tabs .tab-btn'); if(secTabBtns && secTabBtns.length){ secTabBtns.forEach(b=> b.addEventListener('click', ()=> showSection(b.dataset.section))); } else { console.warn('No secondary tab buttons found at init'); }
// also add a delegated listener as a fallback (captures clicks even if buttons are re-rendered)
document.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('.secondary-tabs .tab-btn');
  if(btn){ console.log('Secondary tab clicked (delegated):', btn.dataset.section); showSection(btn.dataset.section); }
});
// file input
const fileInputEl = document.getElementById('fileInput'); if(fileInputEl) fileInputEl.addEventListener('change', (e)=> handleFileInput(e.target.files));
const uploadFileBtnEl = document.getElementById('uploadFileBtn'); if(uploadFileBtnEl) uploadFileBtnEl.addEventListener('click', ()=> fileInputEl && fileInputEl.click());
// new record button
const newRecordBtnEl = document.getElementById('newRecordBtn'); if(newRecordBtnEl) newRecordBtnEl.addEventListener('click', ()=> openNewRecordModal());
// save draft
const saveDraftEl = document.getElementById('saveDraft'); if(saveDraftEl) saveDraftEl.addEventListener('click', ()=>{ if(!state.selectedAppt){ showToast('No appointment selected'); return; } state.draft = Object.assign({}, state.selectedAppt); saveState(); showToast('Draft saved'); });
// quick actions
const qaBookEl = document.getElementById('qa-book'); if(qaBookEl) qaBookEl.onclick = ()=> openBookingFlow();
const qaConsultEl = document.getElementById('qa-consult'); if(qaConsultEl) qaConsultEl.onclick = ()=> showConsultModal();
const qaUploadEl = document.getElementById('qa-upload'); if(qaUploadEl) qaUploadEl.onclick = ()=> fileInputEl && fileInputEl.click();
const qaSosEl = document.getElementById('qa-sos'); if(qaSosEl) qaSosEl.onclick = ()=> showToast('SOS: emergency services will be contacted');
// compose
const composeBtnEl = document.getElementById('composeBtn'); if(composeBtnEl) composeBtnEl.onclick = ()=> composeMessage();
// invoice render
renderBilling();
// keyboard: Esc closes modals
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ const m=document.querySelector('.modal'); if(m){ const bp=document.querySelector('.backdrop-fixed'); m.remove(); if(bp) bp.remove(); } } });

// default
showView('home'); showSection('overview');

// Setup profile editor observer: when showView populates #apptDetails for profile, replace with enhanced editor that saves medical details
(function(){ const apptDetails = document.getElementById('apptDetails'); if(!apptDetails) return; const mo = new MutationObserver((mutations)=>{ for(const m of mutations){ if(m.type === 'childList'){ const saveEl = apptDetails.querySelector('#saveProfile'); if(saveEl){ const profileName = state.profile.name || 'Matilda'; const profileMedical = state.profile.medicalDetails || ''; apptDetails.innerHTML = `<div style='font-weight:700'>${profileName}</div><div style='color:var(--muted);margin-top:6px'>Editable profile â€” change details below</div><div style='margin-top:8px'><label class='label'>Name</label><input id='profileName' class='input-field' value='${profileName}' /></div><div style='margin-top:8px'><label class='label'>Medical details</label><textarea id='profileMedical' class='input-field' style='height:120px'>${profileMedical}</textarea></div><div style='margin-top:8px;display:flex;gap:8px'><button id='saveProfileEnhanced' class='btn-primary'>Save</button><button id='cancelProfileEnhanced' class='btn-outline'>Cancel</button></div>`; const s = document.getElementById('saveProfileEnhanced'); if(s) s.onclick = ()=>{ const v=document.getElementById('profileName').value.trim(); const m=document.getElementById('profileMedical').value.trim(); if(v) state.profile.name = v; state.profile.medicalDetails = m; saveState(); const pg = document.getElementById('profileGreeting'); if(pg) pg.innerText = state.profile.name || 'Matilda'; const g = document.querySelector('.greeting'); if(g) g.innerText = `Welcome, ${state.profile.name || 'Matilda'}`; showToast('Profile saved'); }; const c = document.getElementById('cancelProfileEnhanced'); if(c) c.onclick = ()=>{ renderAppointmentPreview(); showView('home'); }; } } } }); mo.observe(apptDetails, { childList:true, subtree:true }); })();

// runtime diagnostics: capture uncaught errors and console.error
(function(){
  const diag = document.createElement('div'); diag.id='diagRoot'; diag.style.position='fixed'; diag.style.left='20px'; diag.style.bottom='120px'; diag.style.maxWidth='420px'; diag.style.zIndex=99999; diag.style.fontSize='13px'; diag.style.color='#111'; document.body.appendChild(diag);
  function addMsg(type,msg){ const el=document.createElement('div'); el.style.background='rgba(255,255,255,0.95)'; el.style.border='1px solid rgba(0,0,0,0.06)'; el.style.padding='8px'; el.style.marginTop='6px'; el.style.borderRadius='8px'; el.style.boxShadow='0 6px 18px rgba(12,20,40,0.06)'; el.innerText = type+': '+msg; diag.appendChild(el); if(diag.childElementCount>6) diag.removeChild(diag.firstChild); }
  window.addEventListener('error', function(e){ try{ addMsg('Error', (e && e.message) || String(e)); }catch(e){} });
  const origErr = console.error; console.error = function(){ try{ addMsg('console.error', Array.from(arguments).map(a=> typeof a === 'string'?a:JSON.stringify(a)).join(' ')); }catch(e){} origErr && origErr.apply(console, arguments); };
  const origWarn = console.warn; console.warn = function(){ try{ addMsg('console.warn', Array.from(arguments).map(a=> typeof a === 'string'?a:JSON.stringify(a)).join(' ')); }catch(e){} origWarn && origWarn.apply(console, arguments); };
})();
</script>
</body>
</html>
